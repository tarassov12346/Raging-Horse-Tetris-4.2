<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Tetris</title>

    <style>
        body {
           font-family: 'Courier New', monospace;
           font-size: 14px;
           background-color: rgb(255, 255, 128);
           text-align: center; /* Центрирование контента */
        }

        /* Главная настройка для сетки Тетриса */
        #table {
            background-color: #ffffff;
            border: 1px black solid;
            border-collapse: collapse; /* Склеивает границы ячеек */
            border-spacing: 0;         /* Убирает промежутки */
            margin: 0 auto;            /* Центрирование таблицы */
        }

        #table td {
            padding: 0;                /* Убирает внутренние отступы в ячейках */
            line-height: 0;            /* Убирает межстрочные интервалы */
        }

        #table img {
            display: block;            /* Убирает микро-отступ под картинкой */
            width: 25px;               /* Настрой размер под свои картинки, если нужно */
            height: 25px;
        }

        /* Стиль для информационной таблицы */
        .info-table {
            background-color: #ffffff;
            border: 1px black solid;
            border-collapse: collapse;
            margin: 10px auto;
            width: 600px;
        }

        .info-table td {
            border: 1px solid black;
            padding: 5px;
        }

        #controls {
            margin-top: 15px;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@5.0.0/bundles/stomp.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>

    <script>
    var stompClient = null;
    var score = 0;

    var isGameOverSoundPlayed = false; // Флаг, чтобы звук не повторялся



    setTimeout(connect, 500);

    function setConnected(connected) {
        $("#leftButton, #rightButton, #rotateButton, #dropButton, #newGameButton, #saveButton, #restartButton")
            .prop("disabled", !connected);
    }

    function connect() {
        var protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        var wsUrl = protocol + "//" + window.location.host + "/websocket";

        stompClient = new window.StompJs.Client({
            webSocketFactory: function () {
                return new WebSocket(wsUrl);
            }
        });

        stompClient.onConnect = function (frame) {
            stompClient.subscribe('/receive/stateObjects', (s) => showState(s.body));
            stompClient.subscribe('/receive/stateFinal', (s) => showFinalState(s.body));
            stompClient.subscribe('/receive/stateSaved', (s) => showSavedState(s.body));
            stompClient.subscribe('/receive/daoGameObjects', (s) => showDaoGame(s.body));

            setConnected(true);
            stompClient.publish({ destination: "/app/start", body: JSON.stringify({ '': '' }) });
        };

        stompClient.onWebSocketClose = () => setConnected(false);
        playSound('snap_sound');
        stompClient.activate();
    }

    function updateMatrix(matrix) {
        for (let i = 0; i < 20; i++) {
            for (let j = 0; j < 12; j++) {
                $("#c" + i + "v" + j).attr("src", "/img/" + matrix[i][j] + ".png");
            }
        }
    }

    function showState(state) {
    var json = JSON.parse(state);
    var status = json['running'];

    // 1. Проверяем очки: если выросли — играем звук очков
    if (json['game']['playerScore'] > score) {
        playSound('score_sound');
        score = json['game']['playerScore'];
    }
    // 2. ЕСЛИ ОЧКИ НЕ ВЫРОСЛИ: проверяем, играет ли фоновая музыка
    else {
        var bgMusic = document.getElementById('game_sound');
        // Запускаем музыку только если она стоит на паузе (т.е. еще не играла или закончилась)
        if (bgMusic && bgMusic.paused) {
            playSound('game_sound');
        }
    }

    $("#playerBox").text(json['game']['playerName']);
    $("#playerScoreBox").text(score);
    $("#tetrisSpeedBox").text('TETRIS at speed ' + (Math.floor(score/10) + 1));

    if (status) {
        $("#gameStatusBox").text('Game status: ON');
        updateMatrix(json['stage']['cells']);
    } else {
        $("#gameStatusBox").text('Game status: PLS WAIT!!!');
        setConnected(false);

        // Играем, только если флаг "ложь"
    if (!isGameOverSoundPlayed) {
        playSound('registered_sound');
        isGameOverSoundPlayed = true; // Сразу блокируем повторы
    }

        playSound('registered_sound');
        snapShot();
    }
}


   function showFinalState(state) {
    var json = JSON.parse(state);
    $("#gameStatusBox").text('Game status: OVER');
    updateMatrix(json['stage']['cells']);
    $("#newGameButton").prop("disabled", false);

    if (status) {
    $("#ragingHorse").show(); // Показываем ковбоя, когда играем
} else {
    $("#ragingHorse").hide(); // Прячем, когда пауза или проигрыш
}


    // Проверяем тот же флаг. Если в showState он уже стал true — здесь звук не сработает
    if (!isGameOverSoundPlayed) {
        playSound('registered_sound');
        isGameOverSoundPlayed = true;
    }
}


    function showSavedState(state) {
        var json = JSON.parse(state);
        $("#gameStatusBox").text('Game is Saved!!!');
        updateMatrix(json['stage']['cells']);
        playSound('registered_sound');
    }

    function showDaoGame(game) {
        var json = JSON.parse(game);
        $("#bestPlayerBox").text(json['playerName']);
        $("#bestPlayerScoreBox").text(json['playerScore']);
    }

    $(function() {
        var tableHtml = "";
        for (var i = 0; i < 20; i++) {
            tableHtml += "<tr>";
            for (var j = 0; j < 12; j++) {
                tableHtml += '<td><img id="c' + i + 'v' + j + '" src="/img/0.png"></td>';
            }
            tableHtml += "</tr>";
        }
        $("#table").html(tableHtml);

        const sounds = ['game_sound', 'score_sound', 'snap_sound', 'registered_sound'];
        const files = ['0', 'score', 'snap', 'registered'];

        $("#newGameButton").click(() => {
        isGameOverSoundPlayed = false; // Сбрасываем флаг для новой игры
            stompClient.publish({ destination: "/app/hello", body: JSON.stringify({ '': '' }) });
            window.location.href = "/html/hello.html";
        });

        $("#leftButton").click(left);
        $("#rightButton").click(right);
        $("#rotateButton").click(rotate);
        $("#dropButton").click(drop);
        $("#saveButton").click(save);
        $("#restartButton").click(restart);
    });

    function left() { stompClient.publish({ destination: "/app/2", body: "{}" }); }
    function right() { stompClient.publish({ destination: "/app/3", body: "{}" }); }
    function rotate() { stompClient.publish({ destination: "/app/1", body: "{}" }); }
    function drop() { stompClient.publish({ destination: "/app/4", body: "{}" }); }
    function save() { stompClient.publish({ destination: "/app/save", body: "{}" }); }
    function restart() { stompClient.publish({ destination: "/app/restart", body: "{}" }); }
    function snapShot() { stompClient.publish({ destination: "/app/snapShot", body: "{}" }); }

    function playSound(id) {
    var audio = document.getElementById(id);
    if (!audio) return;

    // ГЛАВНОЕ ИСПРАВЛЕНИЕ:
    // Если это фоновая музыка (game_sound)
    if (id === 'game_sound') {
        audio.loop = true; // На всякий случай включаем цикл
        // Если музыка УЖЕ играет, просто выходим из функции и не прерываем её
        if (!audio.paused) {
            return;
        }
    }

    // Для эффектов (очки, падение) — всегда сбрасываем в начало, чтобы звук был четким
    if (id !== 'game_sound') {
        audio.currentTime = 0;
    }

    // Запускаем воспроизведение
    audio.play().catch(function(error) {
        // Игнорируем ошибку, если пользователь еще не кликнул по странице
        console.log("Audio play blocked or failed: ", error);
    });
}





    document.onkeydown = function(e) {
        if (e.keyCode == 37) left();
        if (e.keyCode == 39) right();
        if (e.keyCode == 40) drop();
        if (e.keyCode == 38) rotate();
    };
</script>
</head>
<body>


<!-- Обертка, которая держит таблицу в центре, а ковбоя — сбоку -->
<div class="game-area-wrapper">
    <h1 id="tetrisSpeedBox">&nbsp;</h1>
    <h2 id="gameStatusBox">&nbsp;</h2>
    <!-- Ковбой СЛЕВА -->
    <div id="rodeo-zone-left" class="rodeo-box">
        <img src="/img/rodeo.gif" class="ragingHorse" alt="Raging Horse Left">
        <div class="dust-cloud"></div>
    </div>

    <table class="info-table">
        <tr>
            <td><b> Player </b></td>
            <td id="playerBox"></td>
            <td><b> Score </b></td>
            <td id="playerScoreBox"></td>
        </tr>
        <tr>
            <td><b> Best Player </b></td>
            <td id="bestPlayerBox"></td>
            <td><b> Best Score </b></td>
            <td id="bestPlayerScoreBox"></td>
        </tr>
    </table>

    <table id="table">
        <!-- Сетка генерируется скриптом -->
    </table>
    <!-- Ковбой СПРАВА (добавленный) -->
    <div id="rodeo-zone-right" class="rodeo-box">
        <img src="/img/rodeo.gif" class="ragingHorse" alt="Raging Horse Right">
        <div class="dust-cloud"></div>
    </div>

</div>







<style>
    .game-area-wrapper {
        position: relative;
        display: inline-block;
        margin: 20px auto;
    }

    /* Общие стили для обоих ковбоев */
    .rodeo-box {
        position: absolute;
        top: 50px;
        width: 200px;
        height: 150px;
        display: flex;
        justify-content: center;
        align-items: flex-end;
    }

    /* Позиция СЛЕВА */
    #rodeo-zone-left {
        left: -250px;
    }

    /* Позиция СПРАВА */
    #rodeo-zone-right {
        right: -250px;
    }

    /* Отражаем правого ковбоя по горизонтали, чтобы он смотрел на таблицу */
    #rodeo-zone-right .ragingHorse {
        transform: scaleX(-1);
    }

    .ragingHorse {
        width: 180px;
        height: auto;
        z-index: 10;
        animation: bucking 0.8s infinite ease-in-out;
        filter: drop-shadow(5px 5px 10px rgba(0,0,0,0.2));
    }

    /* Совмещаем анимацию брыкания с отражением для правого ковбоя */
    #rodeo-zone-right .ragingHorse {
        animation: bucking-right 0.8s infinite ease-in-out;
    }

    /* Твоя пыль (остается без изменений) */
    .dust-cloud {
        position: absolute;
        bottom: 10px;
        width: 60px;
        height: 15px;
        background: rgba(139, 69, 19, 0.3);
        border-radius: 50%;
        filter: blur(5px);
        animation: dust 0.8s infinite;
    }

    /* Анимация для левого (обычная) */
    @keyframes bucking {
        0%   { transform: translateY(0) rotate(0deg); }
        25%  { transform: translateY(-15px) rotate(-5deg); }
        50%  { transform: translateY(5px) rotate(5deg); }
        75%  { transform: translateY(-10px) rotate(-2deg); }
        100% { transform: translateY(0) rotate(0deg); }
    }

    /* Анимация для правого (с сохранением отражения scaleX(-1)) */
    @keyframes bucking-right {
        0%   { transform: scaleX(-1) translateY(0) rotate(0deg); }
        25%  { transform: scaleX(-1) translateY(-15px) rotate(5deg); }
        50%  { transform: scaleX(-1) translateY(5px) rotate(-5deg); }
        75%  { transform: scaleX(-1) translateY(-10px) rotate(2deg); }
        100% { transform: scaleX(-1) translateY(0) rotate(0deg); }
    }

    @keyframes dust {
        0%, 100% { transform: scale(1); opacity: 0.3; }
        50% { transform: scale(1.5); opacity: 0.1; }
    }

    /* Стили таблицы остаются прежними */
    #table {
        border-collapse: collapse;
        border-spacing: 0;
        margin: 0 auto !important;
    }
    #table td { padding: 0; line-height: 0; }
    #table img { display: block; width: 25px; height: 25px; }
</style>



<div id="controls">
    <button id="leftButton" disabled>Left</button>
    <button id="rotateButton" disabled>Rotate</button>
    <button id="dropButton" disabled>Drop</button>
    <button id="newGameButton" disabled>NewGame</button>
    <button id="saveButton" disabled>Save</button>
    <button id="restartButton" disabled>Restart</button>
    <button id="rightButton" disabled>Right</button>
</div>

<!-- Замените свои аудио-теги на эти -->
<audio id="game_sound" src="/sounds/0.mp3" loop preload="auto"></audio>
<audio id="score_sound" src="/sounds/score.mp3" preload="auto"></audio>
<audio id="snap_sound" src="/sounds/snap.mp3" preload="auto"></audio>
<audio id="registered_sound" src="/sounds/registered.mp3" preload="auto"></audio>


</body>
</html>
