<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <meta charset="UTF-8">
    <title>Tetris</title>

    <style>
        body {
           font-family: 'Courier New', monospace;
           font-size: 14px;
           background-color: rgb(255, 255, 128);
        }

    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@5.0.0/bundles/stomp.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>

    <script>

     var BASE_URL = "http://localhost:8080"; // Ваша переменная
 // var BASE_URL = "https://animated-space-fiesta-49rpjqwg9px2jp57-8080.app.github.dev";
        var stompClient = null;
        var score = 0;

       setTimeout(connect,500);

        function setConnected(connected) {
            $("#leftButton").prop("disabled", connected);
            $("#rightButton").prop("disabled", connected);
            $("#rotateButton").prop("disabled", connected);
            $("#dropButton").prop("disabled", connected);
            $("#newGameButton").prop("disabled", connected);
            $("#saveButton").prop("disabled", connected);
            $("#restartButton").prop("disabled", connected);
        }

        function frameHandlerState(frame) {
            setConnected(true);
            console.log('Connected: ' + frame);
            stompClient.subscribe('/receive/stateObjects', function (state) {
                showState(state.body);
            });
        }

        function frameHandlerFinalState(frame) {
            setConnected(true);
            console.log('Connected: ' + frame);
            stompClient.subscribe('/receive/stateFinal', function (state) {
                showFinalState(state.body);
            });
        }

        function frameHandlerSavedState(frame) {
            setConnected(true);
            console.log('Connected: ' + frame);
            stompClient.subscribe('/receive/stateSaved', function (state) {
                showSavedState(state.body);
            });
        }

        function frameHandlerDaoGame(frame) {
             stompClient.subscribe('/receive/daoGameObjects', function (game) {
                showDaoGame(game.body);
            });
        }

        function connect() {
            // Генерируем ws адрес из BASE_URL (заменяет http на ws)
            var wsUrl = BASE_URL.replace(/^http/, 'ws') + "/websocket";

 //var wsUrl = BASE_URL.replace(/^https/, 'wss') + "/websocket";
            stompClient = new window.StompJs.Client({
                webSocketFactory: function () {
                    return new WebSocket(wsUrl);
                }
            });
            stompClient.onConnect = function (frame) {
                frameHandlerState(frame);
                frameHandlerFinalState(frame);
                frameHandlerDaoGame(frame);
                frameHandlerSavedState(frame);
                setConnected(false);
                stompClient.publish({
                    destination: "/app/start",
                    body: JSON.stringify({
                        '': ''
                    })
                });
            };
            stompClient.onWebsocketClose = function () {
                if (typeof onSocketClose === "function") onSocketClose();
            };
            playSound('snap_sound');
            stompClient.activate();
        }

        function start() {
            stompClient.publish({
                destination:"/app/start",
                body: JSON.stringify({
                  '': ''
                })
            });
        }

        function save() {
            stompClient.publish({
                destination:"/app/save",
                body: JSON.stringify({
                  '': ''
                })
            });
        }

        function restart() {
            stompClient.publish({
                destination:"/app/restart",
                body: JSON.stringify({
                  '': ''
                })
            });
        }

        function showSavedState(state) {
            var jsonState = JSON.parse(state);
            var matrix = jsonState['stage']['cells'];
            var speed = score/10+1;
            var status = jsonState['running'];
            if (jsonState['game']['playerScore']> score) {
                score = jsonState['game']['playerScore'];
            }
            $("#playerBox").text(jsonState['game']['playerName']);
            $("#playerScoreBox").text(score);
            $("#tetrisSpeedBox").text('TETRIS at speed ' + speed);

            $("#gameStatusBox").text('Game is Saved!!!');
            playSound('registered_sound');

            for (let i = 0; i < 20; i++) {
                for (let j = 0; j < 12; j++) {
                      // ЗАМЕНА: используем BASE_URL вместо localhost
                      $("#c"+i+"v"+j).attr("src", BASE_URL + "/img/" + matrix[i][j] + ".png");
                }
            }
            $("#leftButton").prop("disabled", true);
            $("#rightButton").prop("disabled", true);
            $("#rotateButton").prop("disabled", true);
            $("#dropButton").prop("disabled", true);
            $("#saveButton").prop("disabled", true);
            $("#restartButton").prop("disabled", true);
            $("#newGameButton").prop("disabled", false);
        }

        function showFinalState(state) {
            var jsonState = JSON.parse(state);
            var matrix = jsonState['stage']['cells'];
            var speed = score/10+1;
            var status = jsonState['running'];
            if (jsonState['game']['playerScore']> score) {
                score = jsonState['game']['playerScore'];
            }
            $("#playerBox").text(jsonState['game']['playerName']);
            $("#playerScoreBox").text(score);
            $("#tetrisSpeedBox").text('TETRIS at speed ' + speed);
            if (status) {
                $("#gameStatusBox").text('Game status: ON');
            } else {
                $("#gameStatusBox").text('Game status: OVER');
                playSound('registered_sound');
            }
            for (let i = 0; i < 20; i++) {
                for (let j = 0; j < 12; j++) {
                    // ЗАМЕНА: подставляем BASE_URL для картинок блоков
                    $("#c"+i+"v"+j).attr("src", BASE_URL + "/img/" + matrix[i][j] + ".png");
                }
            }
            $("#leftButton").prop("disabled", true);
            $("#rightButton").prop("disabled", true);
            $("#rotateButton").prop("disabled", true);
            $("#dropButton").prop("disabled", true);
            $("#saveButton").prop("disabled", true);
            $("#restartButton").prop("disabled", true);
            $("#newGameButton").prop("disabled", false);
        }

       function showState(state) {
            var jsonState = JSON.parse(state);
            var matrix = jsonState['stage']['cells'];
            var speed = score/10+1;
            var status = jsonState['running'];
            if (jsonState['game']['playerScore']> score) {
                playSound('score_sound');
                score = jsonState['game']['playerScore'];
            }
            else { playSound('game_sound'); }
            $("#playerBox").text(jsonState['game']['playerName']);
            $("#playerScoreBox").text(score);
            $("#tetrisSpeedBox").text('TETRIS at speed ' + speed);
            if (status) {
                $("#gameStatusBox").text('Game status: ON');
            } else {
                $("#gameStatusBox").text('Game status: PLS WAIT!!!');
                $("#leftButton").prop("disabled", true);
                $("#rightButton").prop("disabled", true);
                $("#rotateButton").prop("disabled", true);
                $("#dropButton").prop("disabled", true);
                $("#newGameButton").prop("disabled", true);
                $("#saveButton").prop("disabled", true);
                $("#restartButton").prop("disabled", true);

                playSound('registered_sound');
            }
            for (let i = 0; i < 20; i++) {
                for (let j = 0; j < 12; j++) {
                      // ЗАМЕНА: подставляем BASE_URL для отрисовки активной игры
                      $("#c"+i+"v"+j).attr("src", BASE_URL + "/img/" + matrix[i][j] + ".png");
                }
            }
            if (!status) snapShot();
       }

        function snapShot() {
            stompClient.publish({
                destination:"/app/snapShot",
                body: JSON.stringify({
                  '': ''
                })
            });
        }

        function showDaoGame(game) {
           var jsonDaoGame = JSON.parse(game);
           var bestPlayer = jsonDaoGame['playerName'];
           var bestScore = jsonDaoGame['playerScore'];
            $("#bestPlayerBox").text(bestPlayer);
            $("#bestPlayerScoreBox").text(bestScore);
        }

$(function() {
    var rows = 20;
    var cols = 12;
    var tableHtml = "";

    // Генерируем сетку
    for (var i = 0; i < rows; i++) {
        tableHtml += "<tr>";
        for (var j = 0; j < cols; j++) {
            tableHtml += '<td><img id="c' + i + 'v' + j + '" src="' + BASE_URL + '/img/0.png"></td>';
        }
        tableHtml += "</tr>";
    }
    $("#table").html(tableHtml);

    // Функция для аудио
    function setAudioSrc(id, fileName) {
        var $audio = $("#" + id);
        if ($audio.length) {
            $audio.find("source[type='audio/mpeg']").attr("src", BASE_URL + "/sounds/" + fileName + ".mp3");
            $audio.find("source[type='audio/ogg']").attr("src", BASE_URL + "/sounds/" + fileName + ".ogg");
            $audio[0].load();
        }
    }

    setAudioSrc("game_sound", "0");
    setAudioSrc("score_sound", "score");
    setAudioSrc("snap_sound", "snap");
    setAudioSrc("registered_sound", "registered");

    // Обработчики кнопок
    $("#newGameButton").click(function() {
        hello();
        window.location = BASE_URL + "/html/profile.html";
    });
    $("#leftButton").click(function() { left(); });
    $("#rightButton").click(function() { right(); });
    $("#rotateButton").click(function() { rotate(); });
    $("#dropButton").click(function() { drop(); });
    $("#saveButton").click(function() { save(); });
    $("#restartButton").click(function() { restart(); });
});

// Функции отправки сообщений (Stomp)
function hello() {
    stompClient.publish({ destination: "/app/hello", body: JSON.stringify({ '': '' }) });
}

function rotate() {
    stompClient.publish({ destination: "/app/1", body: JSON.stringify({ '': '' }) });
}

function left() {
    stompClient.publish({ destination: "/app/2", body: JSON.stringify({ '': '' }) });
}

function right() {
    stompClient.publish({ destination: "/app/3", body: JSON.stringify({ '': '' }) });
}

function drop() {
    stompClient.publish({ destination: "/app/4", body: JSON.stringify({ '': '' }) });
}

function playSound(id) {
    var audio = document.getElementById(id);
    if (!audio) return;
    if (id == 'snap_sound') {
        if (typeof audio.loop == 'boolean') {
            audio.loop = true;
        } else {
            audio.addEventListener('ended', function() {
                this.currentTime = 0;
                this.play();
            }, false);
        }
    }
    audio.play();
}

// Управление клавишами
document.onkeydown = function(e) {
    if (e.keyCode == 37) left();
    if (e.keyCode == 39) right();
    if (e.keyCode == 40) drop();
    if (e.keyCode == 38) rotate();
};

</script>
</head>
<body>

<h1 text align="center"><b id="tetrisSpeedBox"> </b></h1>
<h2 text align="center"><b id="gameStatusBox"> </b></h2>

<table align="center" style="background-color: #ffffff; border:1px black solid;" border="1" width="600">
    <tr>
        <td><b> Player </b></td>
        <td id="playerBox"></td>
        <td><b> Score </b></td>
        <td id="playerScoreBox"></td>
    </tr>
    <tr>
        <td><b> Best Player </b></td>
        <td id="bestPlayerBox"></td>
        <td><b> Best Score </b></td>
        <td id="bestPlayerScoreBox"></td>
    </tr>
</table>

<table id="table" align="center" style="background-color: #ffffff; border:1px black solid;">

</table>
</div>

<div id="controls" align="center">
    <button id="leftButton" disabled>Left</button>
    <button id="rotateButton" disabled>Rotate</button>
    <button id="dropButton" disabled>Drop</button>
    <button id="newGameButton" disabled>NewGame</button>
    <button id="saveButton" disabled>Save</button>
    <button id="restartButton" disabled>Restart</button>
    <button id="rightButton" disabled>Right</button>
</div>

<audio id="game_sound">
    <source type="audio/mpeg">
    <source type="audio/ogg">
</audio>

<audio id="score_sound">
    <source type="audio/mpeg">
    <source type="audio/ogg">
</audio>

<audio id="snap_sound">
    <source type="audio/mpeg">
    <source type="audio/ogg">
</audio>

<audio id="registered_sound">
    <source type="audio/mpeg">
    <source type="audio/ogg">
</audio>

</body>
</html>