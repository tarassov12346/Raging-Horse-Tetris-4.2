<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <meta charset="UTF-8">
    <title>Tetris</title>

    <style>
        body {
           font-family: 'Courier New', monospace;
           font-size: 14px;
           background-color: rgb(255, 255, 128);
        }

    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@5.0.0/bundles/stomp.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>

    <script>
    // --- УНИВЕРСАЛЬНАЯ КОНФИГУРАЦИЯ ---
    var BASE_URL = window.location.origin;
    // ---------------------------

    var stompClient = null;
    var score = 0;

    setTimeout(connect, 500);

    function setConnected(connected) {
        // Кнопки активны, когда connected = true
        $("#leftButton, #rightButton, #rotateButton, #dropButton, #newGameButton, #saveButton, #restartButton")
            .prop("disabled", !connected);
    }

    function connect() {
        var protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        var wsUrl = protocol + "//" + window.location.host + "/websocket";

        stompClient = new window.StompJs.Client({
            webSocketFactory: function () {
                return new WebSocket(wsUrl);
            }
        });

        stompClient.onConnect = function (frame) {
            console.log('Connected: ' + frame);

            stompClient.subscribe('/receive/stateObjects', (s) => showState(s.body));
            stompClient.subscribe('/receive/stateFinal', (s) => showFinalState(s.body));
            stompClient.subscribe('/receive/stateSaved', (s) => showSavedState(s.body));
            stompClient.subscribe('/receive/daoGameObjects', (s) => showDaoGame(s.body));

            setConnected(true);

            stompClient.publish({
                destination: "/app/start",
                body: JSON.stringify({ '': '' })
            });
        };

        stompClient.onWebSocketClose = () => setConnected(false);

        playSound('snap_sound');
        stompClient.activate();
    }

    // Общая функция отрисовки матрицы
    function updateMatrix(matrix) {
        for (let i = 0; i < 20; i++) {
            for (let j = 0; j < 12; j++) {
                // Используем относительный путь для картинок
                $("#c" + i + "v" + j).attr("src", "/img/" + matrix[i][j] + ".png");
            }
        }
    }

    function showState(state) {
        var json = JSON.parse(state);
        var status = json['running'];

        if (json['game']['playerScore'] > score) {
            playSound('score_sound');
            score = json['game']['playerScore'];
        } else {
            playSound('game_sound');
        }

        $("#playerBox").text(json['game']['playerName']);
        $("#playerScoreBox").text(score);
        $("#tetrisSpeedBox").text('TETRIS at speed ' + (score/10 + 1));

        if (status) {
            $("#gameStatusBox").text('Game status: ON');
            updateMatrix(json['stage']['cells']);
        } else {
            $("#gameStatusBox").text('Game status: PLS WAIT!!!');
            setConnected(false);
            playSound('registered_sound');
            snapShot();
        }
    }

    function showFinalState(state) {
        var json = JSON.parse(state);
        $("#gameStatusBox").text('Game status: OVER');
        updateMatrix(json['stage']['cells']);
        $("#newGameButton").prop("disabled", false);
        playSound('registered_sound');
    }

    function showSavedState(state) {
        var json = JSON.parse(state);
        $("#gameStatusBox").text('Game is Saved!!!');
        updateMatrix(json['stage']['cells']);
        playSound('registered_sound');
    }

    function showDaoGame(game) {
        var json = JSON.parse(game);
        $("#bestPlayerBox").text(json['playerName']);
        $("#bestPlayerScoreBox").text(json['playerScore']);
    }

    $(function() {
        // Генерация сетки через относительные пути
        var tableHtml = "";
        for (var i = 0; i < 20; i++) {
            tableHtml += "<tr>";
            for (var j = 0; j < 12; j++) {
                tableHtml += '<td><img id="c' + i + 'v' + j + '" src="/img/0.png"></td>';
            }
            tableHtml += "</tr>";
        }
        $("#table").html(tableHtml);

        // Настройка звуков через относительные пути
        const sounds = ['game_sound', 'score_sound', 'snap_sound', 'registered_sound'];
        const files = ['0', 'score', 'snap', 'registered'];

        sounds.forEach((id, idx) => {
            var $a = $("#" + id);
            $a.find("source[type='audio/mpeg']").attr("src", "/sounds/" + files[idx] + ".mp3");
            $a.find("source[type='audio/ogg']").attr("src", "/sounds/" + files[idx] + ".ogg");
            $a[0].load();
        });

        // Кнопки
        $("#newGameButton").click(() => {
            stompClient.publish({ destination: "/app/hello", body: JSON.stringify({ '': '' }) });
            window.location.href = "/html/profile.html";
        });

        $("#leftButton").click(left);
        $("#rightButton").click(right);
        $("#rotateButton").click(rotate);
        $("#dropButton").click(drop);
        $("#saveButton").click(save);
        $("#restartButton").click(restart);
    });

    // Управление
    function left() { stompClient.publish({ destination: "/app/2", body: "{}" }); }
    function right() { stompClient.publish({ destination: "/app/3", body: "{}" }); }
    function rotate() { stompClient.publish({ destination: "/app/1", body: "{}" }); }
    function drop() { stompClient.publish({ destination: "/app/4", body: "{}" }); }
    function save() { stompClient.publish({ destination: "/app/save", body: "{}" }); }
    function restart() { stompClient.publish({ destination: "/app/restart", body: "{}" }); }
    function snapShot() { stompClient.publish({ destination: "/app/snapShot", body: "{}" }); }

    function playSound(id) {
        var audio = document.getElementById(id);
        if (audio) audio.play().catch(() => {});
    }

    document.onkeydown = function(e) {
        if (e.keyCode == 37) left();
        if (e.keyCode == 39) right();
        if (e.keyCode == 40) drop();
        if (e.keyCode == 38) rotate();
    };
</script>

</head>
<body>

<h1 text align="center"><b id="tetrisSpeedBox"> </b></h1>
<h2 text align="center"><b id="gameStatusBox"> </b></h2>

<table align="center" style="background-color: #ffffff; border:1px black solid;" border="1" width="600">
    <tr>
        <td><b> Player </b></td>
        <td id="playerBox"></td>
        <td><b> Score </b></td>
        <td id="playerScoreBox"></td>
    </tr>
    <tr>
        <td><b> Best Player </b></td>
        <td id="bestPlayerBox"></td>
        <td><b> Best Score </b></td>
        <td id="bestPlayerScoreBox"></td>
    </tr>
</table>

<table id="table" align="center" style="background-color: #ffffff; border:1px black solid;">

</table>
</div>

<div id="controls" align="center">
    <button id="leftButton" disabled>Left</button>
    <button id="rotateButton" disabled>Rotate</button>
    <button id="dropButton" disabled>Drop</button>
    <button id="newGameButton" disabled>NewGame</button>
    <button id="saveButton" disabled>Save</button>
    <button id="restartButton" disabled>Restart</button>
    <button id="rightButton" disabled>Right</button>
</div>

<audio id="game_sound">
    <source type="audio/mpeg">
    <source type="audio/ogg">
</audio>

<audio id="score_sound">
    <source type="audio/mpeg">
    <source type="audio/ogg">
</audio>

<audio id="snap_sound">
    <source type="audio/mpeg">
    <source type="audio/ogg">
</audio>

<audio id="registered_sound">
    <source type="audio/mpeg">
    <source type="audio/ogg">
</audio>

</body>
</html>