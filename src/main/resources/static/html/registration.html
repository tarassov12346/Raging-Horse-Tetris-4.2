<!DOCTYPE html>
<html lang="en" >
<head>
    <meta charset="UTF-8">
    <title>REGISTRATION</title>

    <style>
        body {
            font-family: 'Courier New', monospace;
            font-size: 25px;
            background-color: rgb(100, 100, 100);
        }
        #registration{text-align: center;}
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@5.0.0/bundles/stomp.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>

    <script>
    // --- УНИВЕРСАЛЬНАЯ КОНФИГУРАЦИЯ ---
    // window.location.origin сам определит http://localhost:8080 или https://...codespaces...
    var BASE_URL = window.location.origin;
    // ---------------------------

    var stompClient = null;

    setTimeout(connect, 500);

    function setConnected(connected) {
        $("#registerButton").prop("disabled", !connected); // Исправлена логика disabled
        $("#logInButton").prop("disabled", !connected);
    }

    function frameHandler(frame) {
        console.log('Connected: ' + frame);
        stompClient.subscribe('/receive/message', function (message) {
            playSound('registered_sound');
            window.alert(message.body);
        });
    }

    function connect() {
        // Автоматически выбираем wss для https и ws для http
        var protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        var wsUrl = protocol + "//" + window.location.host + "/register";

        stompClient = new window.StompJs.Client({
            webSocketFactory: function () {
                return new WebSocket(wsUrl);
            }
        });

        stompClient.onConnect = function (frame) {
            frameHandler(frame);
            setConnected(true); // Кнопки активны при подключении
        };

        stompClient.onWebSocketClose = function () {
            setConnected(false);
            console.log("Socket closed");
        };

        stompClient.activate();
    }

    function sendUser() {
        stompClient.publish({
            destination:"/app/register",
            body: JSON.stringify({
                'username': $("#username").val(),
                'password': $("#password").val(),
                'passwordConfirm': $("#passwordConfirm").val()
            })
        });
    }

    $(function () {
        $("#registerButton").click(function () {
            sendUser();
        });

        // Используем относительные пути для звуков — браузер сам добавит домен и правильный протокол
        $("#registered_sound source[type='audio/mpeg']").attr("src", "/sounds/registered.mp3");
        $("#registered_sound source[type='audio/ogg']").attr("src", "/sounds/registered.ogg");

        // Исправляем путь к картинке, если она тоже не грузится
        $(".displayed").attr("src", "/img/black.png");
    });

    function playSound(id){
        var audio = document.getElementById(id);
        if (audio) {
            audio.load();
            audio.play().catch(e => console.log("Audio play failed:", e));
        }
    }

    function logIn() {
        // Относительный путь для перехода
        window.location.href = "/html/hello.html";
    }
</script>

</head>

<body>

<div id="registration">
    <h2>REGISTRATION FORM</h2>
    <p>New users name: <input type="text" id="username"></p>
    <p>New users password: <input type="password" id="password"></p>
    <p>New users password confirm: <input type="password" id="passwordConfirm"></p>

    <button id="registerButton" disabled type="submit">REGISTER YOURSELF AS USER</button>

    <div id="controls">
        <button id="logInButton" disabled type="button" class="buttonLogIn" onclick="logIn()" >LOGIN</button>
    </div>

    <img class="displayed" src="../img/black.png" alt="" width="240" height="384" >
</div>

<audio id="registered_sound">
    <!-- src будут установлены через jQuery при загрузке страницы -->
    <source type="audio/mpeg"></source>
    <source type="audio/ogg"></source>
</audio>

</body>
</html>
