<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel</title>
    <link href="https://cdnjs.cloudflare.com" rel="stylesheet"/>
    <style>
        body {
            background-color: rgb(209, 209, 209);
            font-family: 'Courier New', monospace;
            padding: 20px;
            text-align: center;
        }

        h1, h2 {
            margin-top: 30px;
            font-weight: bold;
        }

        /* Общие стили для таблиц */
        table {
            background-color: #fff;
            margin: 20px auto;
            border-collapse: collapse;
            width: 90%;
            max-width: 1000px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        th, td {
            border: 1px solid #999;
            padding: 12px;
            text-align: center;
        }

        th {
            background-color: #444;
            color: #fff;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        /* Кнопки */
        .btn-delete {
            background-color: #d9534f;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-delete:hover {
            background-color: #c9302c;
        }

        .buttonProfile {
            font-size: 18px;
            background-color: #0a0a11;
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            margin-top: 20px;
            transition: 0.3s;
        }

        .buttonProfile:disabled {
            background-color: #666;
        }

        img.displayed {
            margin: 30px auto;
            border: 2px solid #000;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@5.0.0/bundles/stomp.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>

    <script>
    var stompClient = null;

    setTimeout(connect, 500);

    function setConnected(connected) {
        $("#profileButton").prop("disabled", !connected);
    }

    function connect() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = protocol + "//" + window.location.host + "/websocket";

        stompClient = new window.StompJs.Client({
            webSocketFactory: () => new WebSocket(wsUrl)
        });

        stompClient.onConnect = function (frame) {
            stompClient.subscribe('/receive/users', (msg) => showUsers(msg.body));
            stompClient.subscribe('/receive/results', (msg) => showResults(msg.body));
            stompClient.subscribe('/receive/alert', (msg) => window.alert(msg.body));

            setConnected(true);
            stompClient.publish({ destination: "/app/admin", body: "{}" });
            playSound('admin_sound');
        };

        stompClient.onWebSocketClose = () => setConnected(false);
        stompClient.activate();
    }

    function showUsers(users) {
        const user = JSON.parse(users);
        $("#users").append(`<tr>
            <td>${user.id}</td>
            <td>${user.username}</td>
            <td>******</td> <!-- Скрываем пароли в админке для безопасности -->
            <td>${user.passwordConfirm || 'User'}</td>
            <td><button class="btn-delete" onclick="deleteUser(${user.id})">DELETE</button></td>
        </tr>`);
    }

    function deleteUser(id) {
        if(!confirm("Are you sure you want to delete user " + id + "?")) return;
        stompClient.publish({
            destination: "/app/admin/" + id,
            body: "{}"
        });
        // Перезагрузка страницы через небольшую паузу
        setTimeout(() => { window.location.reload(); }, 500);
    }

    function showResults(game) {
        const res = JSON.parse(game);
        $("#results").append(`<tr>
            <td>${res.id}</td>
            <td>${res.playerName}</td>
            <td>${res.playerScore}</td>
        </tr>`);
    }

    $(function () {
        $("#profileButton").click(() => { window.location.href = "/html/profile.html"; });
    });

    function playSound(id) {
        const audio = document.getElementById(id);
        if (audio) audio.play().catch(e => console.log("Audio blocked"));
    }
</script>
</head>
<body>

<h1>ALL REGISTERED USERS</h1>
<table id="users">
    <thead>
    <tr>
        <th>ID</th>
        <th>USER</th>
        <th>PASSWORD</th>
        <th>ROLES</th>
        <th>CONTROLS</th>
    </tr>
    </thead>
    <tbody><!-- Сюда JS добавит строки --></tbody>
</table>

<h2>USERS BEST SCORES</h2>
<table id="results">
    <thead>
    <tr>
        <th>ID</th>
        <th>PLAYER</th>
        <th>SCORE</th>
    </tr>
    </thead>
    <tbody><!-- Сюда JS добавит строки --></tbody>
</table>

<button id="profileButton" disabled class="buttonProfile">Go to Profile</button>

<div id="images">
    <img class="displayed" src="/img/black.png" alt="Admin Decor" width="240" height="384">
</div>

<audio id="admin_sound" src="/sounds/admin.mp3" preload="auto"></audio>

</body>
</html>
