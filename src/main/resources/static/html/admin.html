<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin</title>

    <style>
          body {
          background-color: rgb(209, 209, 209);
           }

          h1 {
             text-align: center;
          },
          h2 {
              text-align: center;
          },
          table,
          thead,
          td,
          th {
              border: 1px solid;
              padding: 20px;
              text-align: center;
          }

          table {
              text-align: center;
          }

          thead {
              text-align: center;
         }

         #usersAll{text-align: center;}
          #usersAll{margin-left: auto;
          margin-right: auto;}

          #users{text-align: center;}
          #users{margin-left: auto;
          margin-right: auto;}
          #results{margin-left: auto;
          margin-right: auto;}

          img.displayed {
          display: block;
          margin-left: auto;
          margin-right: auto }

          .buttonProfile {
           font-size: 16px;
           background-color:#0a0a11;
           color: #fff;
          }


      </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@5.0.0/bundles/stomp.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>


    <script>
    // --- УНИВЕРСАЛЬНАЯ КОНФИГУРАЦИЯ ---
    const BASE_URL = window.location.origin;
    var stompClient = null;

    setTimeout(connect, 500);

    function setConnected(connected) {
        $("#profileButton").prop("disabled", !connected);
    }

    function connect() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = protocol + "//" + window.location.host + "/websocket";

        stompClient = new window.StompJs.Client({
            webSocketFactory: () => new WebSocket(wsUrl)
        });

        stompClient.onConnect = function (frame) {
            console.log('Connected Admin: ' + frame);
            stompClient.subscribe('/receive/users', (msg) => showUsers(msg.body));
            stompClient.subscribe('/receive/results', (msg) => showResults(msg.body));
            stompClient.subscribe('/receive/alert', (msg) => window.alert(msg.body));

            setConnected(true);
            sendForAdmin();
        };

        stompClient.onWebSocketClose = () => setConnected(false);

        playSound('admin_sound');
        stompClient.activate();
    }

    function showUsers(users) {
        const jsonUser = JSON.parse(users);
        $("#users").append(`<tr>
            <td>${jsonUser.id}</td>
            <td>${jsonUser.username}</td>
            <td>${jsonUser.password}</td>
            <td>${jsonUser.passwordConfirm}</td>
            <td><button class="btn btn-danger" onclick="deleteUser(${jsonUser.id})">DELETE ${jsonUser.id}</button></td>
        </tr>`);
    }

    function deleteUser(id) {
        if(!confirm("Are you sure?")) return;
        stompClient.publish({
            destination: "/app/admin/" + id,
            body: JSON.stringify({ '': '' })
        });
        // Используем относительный путь для обновления
        setTimeout(() => { window.location.href = "/html/admin.html"; }, 300);
    }

    function showResults(game) {
        const jsonGame = JSON.parse(game);
        $("#results").append(`<tr>
            <td>${jsonGame.id}</td>
            <td>${jsonGame.playerName}</td>
            <td>${jsonGame.playerScore}</td>
        </tr>`);
    }

    function profile() {
        window.location.href = "/html/profile.html";
    }

    $(function () {
        // Относительные пути для аудио
        $("#admin-mp3").attr("src", "/sounds/admin.mp3");
        $("#admin-ogg").attr("src", "/sounds/admin.ogg");
        const audio = document.getElementById("admin_sound");
        if (audio) audio.load();

        // Относительные пути для картинок
        $(".js-url").each(function() {
            const path = $(this).data("src");
            if (path) $(this).attr("src", path);
        });

        $("#profileButton").click(profile);
    });

    function sendForAdmin() {
        stompClient.publish({
            destination: "/app/admin",
            body: JSON.stringify({ '': '' })
        });
    }

    function playSound(id) {
        const audio = document.getElementById(id);
        if (audio) audio.play().catch(e => console.log("Autoplay blocked"));
    }
</script>

</head>

<body>

<div id="usersAll">
    <h1>ALL REGISTERED USERS</h1>
    <table class="table table-striped" id="users">
        <thead>
        <tr>
            <th>ID</th>
            <th>USER</th>
            <th>PASSWORD</th>
            <th>ROLES</th>
            <th>CONTROLS</th>
        </tr>
        </thead>
    </table>

    <h2>USERS BEST SCORES</h2>
    <table id="results">
        <thead>
        <tr>
            <th>ID</th>
            <th>PLAYER</th>
            <th>SCORE</th>
        </tr>
        </thead>
    </table>
    <button id="profileButton" disabled type="button" class="buttonProfile" >Your Profile</button>
</div>

<div id="images">
    <!-- Добавили класс js-url и data-src -->
    <img class="displayed js-url" data-src="/img/black.png" src="" alt="" width="240" height="384" >
</div>

<audio id="admin_sound">
    <!-- ID для управления путями -->
    <source id="admin-mp3" type="audio/mpeg">
    <source id="admin-ogg" type="audio/ogg">
</audio>

</body>

</html>